const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-vnc-BgsbSd6u.js","assets/vendor-terminal-Co9mG8Of.js","assets/vendor-terminal-C0BCwPpi.css"])))=>i.map(i=>d[i]);
import{c as ue,r as c,j as s,q as ge,_ as oe,b as fe}from"./index-B2pomQzr.js";import{S as he}from"./send-CTf7Ha86.js";import{C as pe}from"./camera-BbL3_yZm.js";import"./vendor-terminal-Co9mG8Of.js";import"./vendor-utils-BeCPKUKe.js";/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=ue("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);let O;function me({host:h,port:P,password:b,viewOnly:I=!1,shared:E=!1,quality:M=6,compression:p=2,onDisconnect:k,onScreenshot:V,profileId:u,profileName:y,enableRecording:D=!1,recordingOptions:m}){const C=c.useRef(null),i=c.useRef(null),[N,U]=c.useState(!1),[Y,f]=c.useState("Connecting..."),X=c.useRef(!1),[S,H]=c.useState(!1),[$,W]=c.useState(null),j=c.useRef(null),_=c.useRef(null),q=c.useRef(null),A=c.useRef(null),R=c.useRef(null),[G,K]=c.useState(!1);c.useEffect(()=>{if(!C.current)return;const e=C.current,r=window.location.protocol==="https:"?"wss:":"ws:",t=window.location.host,d=`${r}//${t}/api/vnc/ws?host=${encodeURIComponent(h)}&port=${P}`;return(async()=>{try{let a;try{a=await oe(()=>import("./vendor-vnc-BgsbSd6u.js").then(n=>n.r),__vite__mapDeps([0,1,2])),O=a.default||a.RFB||a}catch{try{a=await oe(()=>import("./vendor-vnc-BgsbSd6u.js").then(g=>g.r),__vite__mapDeps([0,1,2])),O=a.default||a.RFB||a}catch(g){console.error("Failed to import noVNC:",g),f("Failed to load VNC client library");return}}if(!O){f("VNC client library not available");return}console.log(`[VNC] Connecting to ${d}`),console.log(`[VNC] Password provided: ${!!b}`);const o=new O(e,d);b&&(o.credentials={password:b},console.log("[VNC] Credentials set on RFB object")),o.addEventListener("connect",()=>{U(!0),f("Connected")}),o.addEventListener("desktopname",n=>{}),o.addEventListener("disconnect",n=>{U(!1);const g=n.detail?.reason||n.detail?.message||"Unknown reason";f(`Disconnected: ${n.detail?.clean?"Clean disconnect":g}`),X.current&&k?.()}),o.addEventListener("credentialsrequired",n=>{if(f("Sending credentials..."),b){o.credentials={password:b};try{if(typeof o.sendCredentials=="function"){o.sendCredentials({password:b});return}if(typeof o.sendPassword=="function"){o.sendPassword(b);return}}catch(g){console.error("Error in credentialsrequired handler:",g),f("Error sending credentials")}}else f("Password required but not provided"),console.error("VNC requires password but none was provided")}),o.addEventListener("securityfailure",n=>{const g=n.detail?.reason||n.detail?.message||"Authentication failed";f(`Security failure: ${g}`),console.error("VNC security failure",n.detail,n)}),o.addEventListener("error",n=>{const g=n.detail?.message||n.detail?.reason||"Connection error";f(`Error: ${g}`),console.error("VNC error",n.detail,n)}),o.scaleViewport=!0,o.resizeSession=!1,o.clipViewport=!1,o.showDotCursor=!0,o.viewOnly=I,o.focusOnClick=!0,typeof o.qualityLevel<"u"&&(o.qualityLevel=M),typeof o.compressionLevel<"u"&&(o.compressionLevel=p),typeof o.shared<"u"&&(o.shared=E),i.current=o}catch(a){console.error("Failed to create VNC connection",a),f(`Connection error: ${a instanceof Error?a.message:"Unknown error"}`)}})(),()=>{X.current=!0,i.current&&(i.current.disconnect(),i.current=null)}},[h,P,b,I,E,M,p]);const re=()=>{X.current=!0,i.current&&i.current.disconnect()},se=()=>{if(console.log("[VNC] Ctrl+Alt+Del button clicked"),console.log("[VNC] RFB connected:",!!i.current,"isConnected:",N),i.current&&N)try{console.log("[VNC] Checking sendCtrlAltDel method..."),typeof i.current.sendCtrlAltDel=="function"?(console.log("[VNC] Sending Ctrl+Alt+Del..."),i.current.sendCtrlAltDel(),console.log("[VNC] Ctrl+Alt+Del sent successfully")):(console.error("[VNC] sendCtrlAltDel method not available on RFB object"),console.log("[VNC] Available methods:",Object.keys(i.current).filter(e=>typeof i.current[e]=="function")))}catch(e){console.error("[VNC] Failed to send Ctrl+Alt+Del:",e)}else console.warn("[VNC] Ctrl+Alt+Del not available - not connected")},Q=c.useCallback(async(e,r)=>{try{console.log(`[VNC Recording] Uploading chunk: ${r.size} bytes`);const t=await r.arrayBuffer(),d=localStorage.getItem("weasel.auth.token"),l={"Content-Type":"application/octet-stream"};d&&(l["X-Weasel-Token"]=d);const a=await fetch(`/api/vnc/recordings/chunk/${e}`,{method:"POST",headers:l,body:t});a.ok?console.log(`[VNC Recording] Chunk uploaded successfully: ${r.size} bytes`):console.error("[VNC Recording] Failed to upload chunk:",a.statusText)}catch(t){console.error("Failed to upload recording chunk:",t)}},[]),Z=c.useCallback(e=>{if(!m?.enableMotionDetection)return!0;const r=e.getContext("2d");if(!r)return!0;const t=r.getImageData(0,0,e.width,e.height),d=q.current;if(!d||d.width!==t.width||d.height!==t.height)return q.current=t,!0;const l=m.motionDetectionBlockSize||32,a=(m.motionDetectionThresholdPercent||10)/100,o=Math.ceil(e.width/l),n=Math.ceil(e.height/l);let g=0;for(let w=0;w<n;w++)for(let x=0;x<o;x++){const T=x*l,ee=w*l;let te=0,J=0;for(let z=0;z<l&&ee+z<e.height;z++)for(let B=0;B<l&&T+B<e.width;B++){const F=((ee+z)*e.width+(T+B))*4,ae=Math.abs(t.data[F]-d.data[F]),ie=Math.abs(t.data[F+1]-d.data[F+1]),de=Math.abs(t.data[F+2]-d.data[F+2]);te+=(ae+ie+de)/3,J++}J>0&&te/J>30&&g++}return q.current=t,g/(o*n)>a},[m]),ce=c.useCallback(async()=>{if(!C.current||!u||!y){console.warn("[VNC Recording] Cannot start recording: missing container, profileId, or profileName");return}try{console.log("[VNC Recording] Starting recording for profile:",y);const e=C.current.querySelector("canvas");if(!(e instanceof HTMLCanvasElement)){console.error("[VNC Recording] Canvas not found for recording");return}const r=localStorage.getItem("weasel.auth.token"),t={"Content-Type":"application/json"};r&&(t["X-Weasel-Token"]=r),console.log("[VNC Recording] Creating recording session on server...");const d=await fetch("/api/vnc/recordings/start",{method:"POST",headers:t,body:JSON.stringify({profileId:u,profileName:y})});if(!d.ok)throw new Error("Failed to start recording session");const l=await d.json();console.log("[VNC Recording] Recording session created:",l.id,"Output:",l.outputPath),W(l);const a=m?.recordingFps||5,n=["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm;codecs=h264","video/webm"].find(w=>MediaRecorder.isTypeSupported(w));if(!n)throw new Error("No supported video codec found");console.log("[VNC Recording] Using codec:",n,"FPS:",a);const g=e.captureStream(a);_.current=g;const v=new MediaRecorder(g,{mimeType:n,videoBitsPerSecond:25e5});if(v.ondataavailable=async w=>{w.data.size>0&&l&&await Q(l.id,w.data)},v.onerror=w=>{console.error("[VNC Recording] MediaRecorder error:",w),L()},console.log("[VNC Recording] Starting MediaRecorder, chunks every 5 seconds..."),v.start(5e3),j.current=v,H(!0),console.log("[VNC Recording] Recording started successfully"),m?.enableMotionDetection){const w=1e3/a;A.current=window.setInterval(()=>{const x=Z(e);if(K(x),l&&fetch(`/api/vnc/recordings/frame-stats/${l.id}`,{method:"POST",headers:t,body:JSON.stringify({motionDetected:x})}).catch(console.error),x)R.current&&(clearTimeout(R.current),R.current=null,console.log("[VNC Recording] Motion detected, cancelling pause timer")),v.state==="paused"&&(console.log("[VNC Recording] Resuming recording due to motion"),v.resume());else if(v.state==="recording"&&!R.current){const T=(m?.motionDetectionPauseDelaySeconds||10)*1e3;console.log(`[VNC Recording] No motion detected, starting ${T/1e3}s pause timer`),R.current=window.setTimeout(()=>{v.state==="recording"&&(console.log(`[VNC Recording] Pausing recording after ${T/1e3}s of no motion`),v.pause()),R.current=null},T)}},w)}}catch(e){console.error("Failed to start recording:",e),H(!1),W(null)}},[u,y,m,Q,Z]),L=c.useCallback(async()=>{try{if(console.log("[VNC Recording] Stopping recording..."),A.current&&(clearInterval(A.current),A.current=null),R.current&&(clearTimeout(R.current),R.current=null),j.current&&j.current.state!=="inactive"){console.log("[VNC Recording] Stopping MediaRecorder, waiting for final chunk...");const e=new Promise(r=>{const t=j.current;if(!t){r();return}const d=t.ondataavailable;t.ondataavailable=async l=>{d&&await d(l),console.log("[VNC Recording] Final chunk uploaded, size:",l.data.size),r()},t.stop()});await Promise.race([e,new Promise(r=>setTimeout(r,1e4))]),j.current=null,console.log("[VNC Recording] MediaRecorder stopped")}if(_.current&&(_.current.getTracks().forEach(e=>e.stop()),_.current=null),$){console.log("[VNC Recording] Notifying server to stop recording:",$.id);const e=localStorage.getItem("weasel.auth.token"),r={};e&&(r["X-Weasel-Token"]=e);const t=await fetch(`/api/vnc/recordings/stop/${$.id}`,{method:"POST",headers:r});t.ok?console.log("[VNC Recording] Recording stopped successfully"):console.error("[VNC Recording] Failed to stop recording on server:",t.statusText)}H(!1),W(null),K(!1),q.current=null}catch(e){console.error("Failed to stop recording:",e)}},[$]);c.useEffect(()=>()=>{S&&L()},[S,L]);const le=()=>{if(console.log("[VNC] Screenshot button clicked"),console.log("[VNC] RFB connected:",!!i.current,"isConnected:",N,"has container:",!!C.current),i.current&&N&&C.current)try{const e=C.current.querySelector("canvas");if(console.log("[VNC] Canvas found:",!!e),e instanceof HTMLCanvasElement){const r=e.toDataURL("image/png");if(console.log("[VNC] Screenshot captured, size:",r.length),V)console.log("[VNC] Calling onScreenshot callback"),V(r);else{console.log("[VNC] No callback, downloading directly");const t=document.createElement("a");t.download=`vnc-screenshot-${new Date().toISOString().replace(/[:.]/g,"-")}.png`,t.href=r,t.click()}}else console.error("[VNC] Canvas element not found in VNC container")}catch(e){console.error("[VNC] Failed to take screenshot:",e)}else console.warn("[VNC] Screenshot not available - not connected or container not ready")};return s.jsxs("div",{className:"flex flex-col w-full h-full bg-black",children:[s.jsxs("div",{className:"bg-slate-900/90 text-white p-2 flex items-center justify-between z-10 shrink-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:`w-2 h-2 rounded-full ${N?"bg-green-500":"bg-red-500"}`}),s.jsx("span",{className:"text-sm",children:Y}),S&&s.jsxs("div",{className:"flex items-center gap-1.5 ml-2 px-2 py-1 bg-red-900/30 border border-red-500/50 rounded",children:[s.jsx(ne,{size:10,className:`fill-red-500 ${G?"animate-pulse":""}`}),s.jsx("span",{className:"text-xs text-red-400",children:"REC"}),m?.enableMotionDetection&&s.jsx("span",{className:"text-xs text-gray-400",children:G?"Motion":"Paused"})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[D&&u&&y&&s.jsxs("button",{type:"button",onClick:S?L:ce,disabled:!N,className:`px-3 py-1 rounded text-sm flex items-center gap-1.5 transition-colors disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed ${S?"bg-red-600 hover:bg-red-700":"bg-blue-600 hover:bg-blue-700"}`,title:S?"Stop Recording":"Start Recording",children:[S?s.jsx(ge,{size:14}):s.jsx(ne,{size:14}),S?"Stop":"Record"]}),s.jsxs("button",{type:"button",onClick:se,disabled:!N,className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed rounded text-sm flex items-center gap-1.5 transition-colors",title:"Send Ctrl+Alt+Delete",children:[s.jsx(he,{size:14}),"Ctrl+Alt+Del"]}),s.jsxs("button",{type:"button",onClick:le,disabled:!N,className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed rounded text-sm flex items-center gap-1.5 transition-colors",title:"Take Screenshot",children:[s.jsx(pe,{size:14}),"Screenshot"]}),s.jsx("button",{type:"button",onClick:re,className:"px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors",children:"Disconnect"})]})]}),s.jsx("div",{ref:C,className:"flex-1 w-full overflow-hidden",style:{display:"block",position:"relative"}})]})}function ve(){const[h,P]=c.useState(null),[b,I]=c.useState();c.useEffect(()=>{const p=new URLSearchParams(window.location.search),k=p.get("host")||localStorage.getItem("vnc_host")||"localhost",V=parseInt(p.get("port")||localStorage.getItem("vnc_port")||"5900",10),u=p.get("password")||localStorage.getItem("vnc_password")||void 0;console.log("[VNC Viewer] Password received:",!!u),console.log("[VNC Viewer] Password length:",u?.length||0),u&&u.length>0&&console.log("[VNC Viewer] Password check (first/last char):",u.charAt(0),u.charAt(u.length-1));const y=p.get("viewOnly")==="true"||localStorage.getItem("vnc_viewOnly")==="true",D=p.get("shared")==="true"||localStorage.getItem("vnc_shared")==="true",m=parseInt(p.get("quality")||localStorage.getItem("vnc_quality")||"6",10),C=parseInt(p.get("compression")||localStorage.getItem("vnc_compression")||"2",10),i=p.get("profileId")||void 0,N=p.get("profileName")||void 0;P({host:k,port:V,password:u,viewOnly:y,shared:D,quality:m,compression:C,profileId:i,profileName:N}),(async()=>{try{const f=await fe("/api/vnc/recordings/config");I(f)}catch(f){console.error("Failed to fetch recording config:",f)}})(),setTimeout(async()=>{try{document.documentElement.requestFullscreen&&await document.documentElement.requestFullscreen()}catch(f){console.log("Could not enter fullscreen:",f)}},100)},[]);const E=()=>{document.fullscreenElement&&document.exitFullscreen(),setTimeout(()=>{window.close()},500)},M=async p=>{try{console.log("[VNC Screenshot] Starting screenshot upload...");const V=await(await fetch(p)).blob();console.log("[VNC Screenshot] Converted to blob, size:",V.size);const u=new FormData,y=`vnc-screenshot-${new Date().toISOString().replace(/[:.]/g,"-")}.png`;u.append("file",V,y),u.append("path","Screenshots"),console.log("[VNC Screenshot] Uploading to Screenshots folder, filename:",y);const D=localStorage.getItem("weasel.auth.token"),m={};D&&(m["X-Weasel-Token"]=D);const C=await fetch("/api/fs/upload",{method:"POST",headers:m,body:u});if(C.ok)console.log("[VNC Screenshot] Screenshot saved successfully:",y);else{const i=await C.text();console.error("[VNC Screenshot] Upload failed:",C.status,i)}}catch(k){console.error("[VNC Screenshot] Failed to save screenshot:",k)}};return h?s.jsx("div",{className:"w-screen h-screen bg-black overflow-hidden",children:s.jsx(me,{host:h.host,port:h.port,password:h.password,viewOnly:h.viewOnly,shared:h.shared,quality:h.quality,compression:h.compression,profileId:h.profileId,profileName:h.profileName,enableRecording:!!h.profileId&&!!b,recordingOptions:b,onDisconnect:E,onScreenshot:M})}):s.jsx("div",{className:"w-screen h-screen bg-black flex items-center justify-center text-white",children:s.jsx("div",{children:"Loading VNC connection..."})})}export{ve as default};
