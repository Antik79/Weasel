const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-vnc-D5urSRlM.js","assets/vendor-terminal-CTS2sXWF.js","assets/vendor-terminal-C0BCwPpi.css"])))=>i.map(i=>d[i]);
import{c as ce,j as n,B as he,S as pe,v as me,_ as re,b as Ce}from"./index-CFy-3w2c.js";import{r as c}from"./vendor-utils-CpUfumj7.js";import{S as we}from"./send-CCdk0kJd.js";import"./vendor-terminal-CTS2sXWF.js";/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=ce("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=ce("Pause",[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]]);let X;function ye({host:h,port:F,password:b,viewOnly:I=!1,shared:E=!1,quality:M=6,compression:p=2,onDisconnect:k,onScreenshot:S,profileId:u,profileName:y,enableRecording:D=!1,recordingOptions:m}){const C=c.useRef(null),i=c.useRef(null),[v,H]=c.useState(!1),[Q,f]=c.useState("Connecting..."),W=c.useRef(!1),[R,J]=c.useState(!1),[$,Y]=c.useState(null),P=c.useRef(null),z=c.useRef(null),A=c.useRef(null),_=c.useRef(null),x=c.useRef(null),[L,Z]=c.useState(!1),[q,G]=c.useState(!1);c.useEffect(()=>{if(!C.current)return;const e=C.current,s=window.location.protocol==="https:"?"wss:":"ws:",t=window.location.host,d=`${s}//${t}/api/vnc/ws?host=${encodeURIComponent(h)}&port=${F}`;return(async()=>{try{let a;try{a=await re(()=>import("./vendor-vnc-D5urSRlM.js").then(r=>r.r),__vite__mapDeps([0,1,2])),X=a.default||a.RFB||a}catch{try{a=await re(()=>import("./vendor-vnc-D5urSRlM.js").then(g=>g.r),__vite__mapDeps([0,1,2])),X=a.default||a.RFB||a}catch(g){console.error("Failed to import noVNC:",g),f("Failed to load VNC client library");return}}if(!X){f("VNC client library not available");return}console.log(`[VNC] Connecting to ${d}`),console.log(`[VNC] Password provided: ${!!b}`);const o=new X(e,d);b&&(o.credentials={password:b},console.log("[VNC] Credentials set on RFB object")),o.addEventListener("connect",()=>{H(!0),f("Connected")}),o.addEventListener("desktopname",r=>{}),o.addEventListener("disconnect",r=>{H(!1);const g=r.detail?.reason||r.detail?.message||"Unknown reason";f(`Disconnected: ${r.detail?.clean?"Clean disconnect":g}`),W.current&&k?.()}),o.addEventListener("credentialsrequired",r=>{if(f("Sending credentials..."),b){o.credentials={password:b};try{if(typeof o.sendCredentials=="function"){o.sendCredentials({password:b});return}if(typeof o.sendPassword=="function"){o.sendPassword(b);return}}catch(g){console.error("Error in credentialsrequired handler:",g),f("Error sending credentials")}}else f("Password required but not provided"),console.error("VNC requires password but none was provided")}),o.addEventListener("securityfailure",r=>{const g=r.detail?.reason||r.detail?.message||"Authentication failed";f(`Security failure: ${g}`),console.error("VNC security failure",r.detail,r)}),o.addEventListener("error",r=>{const g=r.detail?.message||r.detail?.reason||"Connection error";f(`Error: ${g}`),console.error("VNC error",r.detail,r)}),o.scaleViewport=!0,o.resizeSession=!1,o.clipViewport=!1,o.showDotCursor=!0,o.viewOnly=I,o.focusOnClick=!0,typeof o.qualityLevel<"u"&&(o.qualityLevel=M),typeof o.compressionLevel<"u"&&(o.compressionLevel=p),typeof o.shared<"u"&&(o.shared=E),i.current=o}catch(a){console.error("Failed to create VNC connection",a),f(`Connection error: ${a instanceof Error?a.message:"Unknown error"}`)}})(),()=>{W.current=!0,i.current&&(i.current.disconnect(),i.current=null)}},[h,F,b,I,E,M,p]);const le=()=>{W.current=!0,i.current&&i.current.disconnect()},ae=()=>{if(console.log("[VNC] Ctrl+Alt+Del button clicked"),console.log("[VNC] RFB connected:",!!i.current,"isConnected:",v),i.current&&v)try{console.log("[VNC] Checking sendCtrlAltDel method..."),typeof i.current.sendCtrlAltDel=="function"?(console.log("[VNC] Sending Ctrl+Alt+Del..."),i.current.sendCtrlAltDel(),console.log("[VNC] Ctrl+Alt+Del sent successfully")):(console.error("[VNC] sendCtrlAltDel method not available on RFB object"),console.log("[VNC] Available methods:",Object.keys(i.current).filter(e=>typeof i.current[e]=="function")))}catch(e){console.error("[VNC] Failed to send Ctrl+Alt+Del:",e)}else console.warn("[VNC] Ctrl+Alt+Del not available - not connected")},ee=c.useCallback(async(e,s)=>{try{console.log(`[VNC Recording] Uploading chunk: ${s.size} bytes`);const t=await s.arrayBuffer(),d=localStorage.getItem("weasel.auth.token"),l={"Content-Type":"application/octet-stream"};d&&(l["X-Weasel-Token"]=d);const a=await fetch(`/api/vnc/recordings/chunk/${e}`,{method:"POST",headers:l,body:t});a.ok?console.log(`[VNC Recording] Chunk uploaded successfully: ${s.size} bytes`):console.error("[VNC Recording] Failed to upload chunk:",a.statusText)}catch(t){console.error("Failed to upload recording chunk:",t)}},[]),te=c.useCallback(e=>{if(!m?.enableMotionDetection)return!0;const s=e.getContext("2d");if(!s)return!0;const t=s.getImageData(0,0,e.width,e.height),d=A.current;if(!d||d.width!==t.width||d.height!==t.height)return A.current=t,!0;const l=m.motionDetectionBlockSize||32,a=(m.motionDetectionThresholdPercent||10)/100,o=Math.ceil(e.width/l),r=Math.ceil(e.height/l);let g=0;for(let w=0;w<r;w++)for(let V=0;V<o;V++){const T=V*l,oe=w*l;let ne=0,K=0;for(let O=0;O<l&&oe+O<e.height;O++)for(let U=0;U<l&&T+U<e.width;U++){const j=((oe+O)*e.width+(T+U))*4,ue=Math.abs(t.data[j]-d.data[j]),ge=Math.abs(t.data[j+1]-d.data[j+1]),fe=Math.abs(t.data[j+2]-d.data[j+2]);ne+=(ue+ge+fe)/3,K++}K>0&&ne/K>30&&g++}return A.current=t,g/(o*r)>a},[m]),ie=c.useCallback(async()=>{if(!C.current||!u||!y){console.warn("[VNC Recording] Cannot start recording: missing container, profileId, or profileName");return}try{console.log("[VNC Recording] Starting recording for profile:",y);const e=C.current.querySelector("canvas");if(!(e instanceof HTMLCanvasElement)){console.error("[VNC Recording] Canvas not found for recording");return}const s=localStorage.getItem("weasel.auth.token"),t={"Content-Type":"application/json"};s&&(t["X-Weasel-Token"]=s),console.log("[VNC Recording] Creating recording session on server...");const d=await fetch("/api/vnc/recordings/start",{method:"POST",headers:t,body:JSON.stringify({profileId:u,profileName:y})});if(!d.ok)throw new Error("Failed to start recording session");const l=await d.json();console.log("[VNC Recording] Recording session created:",l.id,"Output:",l.outputPath),Y(l);const a=m?.recordingFps||5,r=["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm;codecs=h264","video/webm"].find(w=>MediaRecorder.isTypeSupported(w));if(!r)throw new Error("No supported video codec found");console.log("[VNC Recording] Using codec:",r,"FPS:",a);const g=e.captureStream(a);z.current=g;const N=new MediaRecorder(g,{mimeType:r,videoBitsPerSecond:25e5});if(N.ondataavailable=async w=>{w.data.size>0&&l&&await ee(l.id,w.data)},N.onerror=w=>{console.error("[VNC Recording] MediaRecorder error:",w),B()},console.log("[VNC Recording] Starting MediaRecorder, chunks every 5 seconds..."),N.start(5e3),P.current=N,J(!0),console.log("[VNC Recording] Recording started successfully"),m?.enableMotionDetection){const w=1e3/a;_.current=window.setInterval(()=>{const V=te(e);if(Z(V),l&&fetch(`/api/vnc/recordings/frame-stats/${l.id}`,{method:"POST",headers:t,body:JSON.stringify({motionDetected:V})}).catch(console.error),V)x.current&&(clearTimeout(x.current),x.current=null,console.log("[VNC Recording] Motion detected, cancelling pause timer")),N.state==="paused"&&(console.log("[VNC Recording] Resuming recording due to motion"),N.resume(),G(!1));else if(N.state==="recording"&&!x.current){const T=(m?.motionDetectionPauseDelaySeconds||10)*1e3;console.log(`[VNC Recording] No motion detected, starting ${T/1e3}s pause timer`),x.current=window.setTimeout(()=>{N.state==="recording"&&(console.log(`[VNC Recording] Pausing recording after ${T/1e3}s of no motion`),N.pause(),G(!0)),x.current=null},T)}},w)}}catch(e){console.error("Failed to start recording:",e),J(!1),Y(null)}},[u,y,m,ee,te]),B=c.useCallback(async()=>{try{if(console.log("[VNC Recording] Stopping recording..."),_.current&&(clearInterval(_.current),_.current=null),x.current&&(clearTimeout(x.current),x.current=null),P.current&&P.current.state!=="inactive"){console.log("[VNC Recording] Stopping MediaRecorder, waiting for final chunk...");const e=new Promise(s=>{const t=P.current;if(!t){s();return}const d=t.ondataavailable;t.ondataavailable=async l=>{d&&await d(l),console.log("[VNC Recording] Final chunk uploaded, size:",l.data.size),s()},t.stop()});await Promise.race([e,new Promise(s=>setTimeout(s,1e4))]),P.current=null,console.log("[VNC Recording] MediaRecorder stopped")}if(z.current&&(z.current.getTracks().forEach(e=>e.stop()),z.current=null),$){console.log("[VNC Recording] Notifying server to stop recording:",$.id);const e=localStorage.getItem("weasel.auth.token"),s={};e&&(s["X-Weasel-Token"]=e);const t=await fetch(`/api/vnc/recordings/stop/${$.id}`,{method:"POST",headers:s});t.ok?console.log("[VNC Recording] Recording stopped successfully"):console.error("[VNC Recording] Failed to stop recording on server:",t.statusText)}J(!1),Y(null),Z(!1),G(!1),A.current=null}catch(e){console.error("Failed to stop recording:",e)}},[$]);c.useEffect(()=>()=>{R&&B()},[R,B]);const de=()=>{if(console.log("[VNC] Screenshot button clicked"),console.log("[VNC] RFB connected:",!!i.current,"isConnected:",v,"has container:",!!C.current),i.current&&v&&C.current)try{const e=C.current.querySelector("canvas");if(console.log("[VNC] Canvas found:",!!e),e instanceof HTMLCanvasElement){const s=e.toDataURL("image/png");if(console.log("[VNC] Screenshot captured, size:",s.length),S)console.log("[VNC] Calling onScreenshot callback"),S(s);else{console.log("[VNC] No callback, downloading directly");const t=document.createElement("a");t.download=`vnc-screenshot-${new Date().toISOString().replace(/[:.]/g,"-")}.png`,t.href=s,t.click()}}else console.error("[VNC] Canvas element not found in VNC container")}catch(e){console.error("[VNC] Failed to take screenshot:",e)}else console.warn("[VNC] Screenshot not available - not connected or container not ready")};return n.jsxs("div",{className:"flex flex-col w-full h-full bg-black",children:[n.jsxs("div",{className:"bg-slate-900/90 text-white p-2 flex items-center justify-between z-10 shrink-0",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:`w-2 h-2 rounded-full ${v?"bg-green-500":"bg-red-500"}`}),n.jsx("span",{className:"text-sm",children:Q}),R&&n.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[n.jsxs("div",{className:`flex items-center gap-1.5 px-2 py-1 rounded border ${q?"bg-yellow-900/30 border-yellow-500/50":"bg-red-900/30 border-red-500/50"}`,children:[q?n.jsx(be,{size:10,className:"text-yellow-500"}):n.jsx(se,{size:10,className:"fill-red-500 animate-pulse"}),n.jsx("span",{className:`text-xs ${q?"text-yellow-400":"text-red-400"}`,children:q?"PAUSED":"REC"})]}),m?.enableMotionDetection&&n.jsxs("div",{className:`flex items-center gap-1.5 px-2 py-1 rounded border ${L?"bg-green-900/30 border-green-500/50":"bg-slate-800/50 border-slate-600/50"}`,children:[n.jsx(he,{size:10,className:L?"text-green-500":"text-slate-500"}),n.jsx("span",{className:`text-xs ${L?"text-green-400":"text-slate-500"}`,children:L?"Motion":"Still"})]})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[D&&u&&y&&n.jsxs("button",{type:"button",onClick:R?B:ie,disabled:!v,className:`px-3 py-1 rounded text-sm flex items-center gap-1.5 transition-colors disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed ${R?"bg-red-600 hover:bg-red-700":"bg-blue-600 hover:bg-blue-700"}`,title:R?"Stop Recording":"Start Recording",children:[R?n.jsx(pe,{size:14}):n.jsx(se,{size:14}),R?"Stop":"Record"]}),n.jsxs("button",{type:"button",onClick:ae,disabled:!v,className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed rounded text-sm flex items-center gap-1.5 transition-colors",title:"Send Ctrl+Alt+Delete",children:[n.jsx(we,{size:14}),"Ctrl+Alt+Del"]}),n.jsxs("button",{type:"button",onClick:de,disabled:!v,className:"px-3 py-1 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed rounded text-sm flex items-center gap-1.5 transition-colors",title:"Take Screenshot",children:[n.jsx(me,{size:14}),"Screenshot"]}),n.jsx("button",{type:"button",onClick:le,className:"px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors",children:"Disconnect"})]})]}),n.jsx("div",{ref:C,className:"flex-1 w-full overflow-hidden",style:{display:"block",position:"relative"}})]})}function Se(){const[h,F]=c.useState(null),[b,I]=c.useState();c.useEffect(()=>{const p=new URLSearchParams(window.location.search),k=p.get("host")||localStorage.getItem("vnc_host")||"localhost",S=parseInt(p.get("port")||localStorage.getItem("vnc_port")||"5900",10),u=p.get("password")||localStorage.getItem("vnc_password")||void 0;console.log("[VNC Viewer] Password received:",!!u),console.log("[VNC Viewer] Password length:",u?.length||0),u&&u.length>0&&console.log("[VNC Viewer] Password check (first/last char):",u.charAt(0),u.charAt(u.length-1));const y=p.get("viewOnly")==="true"||localStorage.getItem("vnc_viewOnly")==="true",D=p.get("shared")==="true"||localStorage.getItem("vnc_shared")==="true",m=parseInt(p.get("quality")||localStorage.getItem("vnc_quality")||"6",10),C=parseInt(p.get("compression")||localStorage.getItem("vnc_compression")||"2",10),i=p.get("profileId")||void 0,v=p.get("profileName")||void 0;F({host:k,port:S,password:u,viewOnly:y,shared:D,quality:m,compression:C,profileId:i,profileName:v}),(async()=>{try{const f=await Ce("/api/vnc/recordings/config");I(f)}catch(f){console.error("Failed to fetch recording config:",f)}})(),setTimeout(async()=>{try{document.documentElement.requestFullscreen&&await document.documentElement.requestFullscreen()}catch(f){console.log("Could not enter fullscreen:",f)}},100)},[]);const E=()=>{document.fullscreenElement&&document.exitFullscreen(),setTimeout(()=>{window.close()},500)},M=async p=>{try{console.log("[VNC Screenshot] Starting screenshot upload...");const S=await(await fetch(p)).blob();console.log("[VNC Screenshot] Converted to blob, size:",S.size);const u=new FormData,y=`vnc-screenshot-${new Date().toISOString().replace(/[:.]/g,"-")}.png`;u.append("file",S,y),u.append("path","Screenshots"),console.log("[VNC Screenshot] Uploading to Screenshots folder, filename:",y);const D=localStorage.getItem("weasel.auth.token"),m={};D&&(m["X-Weasel-Token"]=D);const C=await fetch("/api/fs/upload",{method:"POST",headers:m,body:u});if(C.ok)console.log("[VNC Screenshot] Screenshot saved successfully:",y);else{const i=await C.text();console.error("[VNC Screenshot] Upload failed:",C.status,i)}}catch(k){console.error("[VNC Screenshot] Failed to save screenshot:",k)}};return h?n.jsx("div",{className:"w-screen h-screen bg-black overflow-hidden",children:n.jsx(ye,{host:h.host,port:h.port,password:h.password,viewOnly:h.viewOnly,shared:h.shared,quality:h.quality,compression:h.compression,profileId:h.profileId,profileName:h.profileName,enableRecording:!!h.profileId&&!!b,recordingOptions:b,onDisconnect:E,onScreenshot:M})}):n.jsx("div",{className:"w-screen h-screen bg-black flex items-center justify-center text-white",children:n.jsx("div",{children:"Loading VNC connection..."})})}export{Se as default};
